# Cogment Verse

[![Apache 2 License](https://img.shields.io/badge/license-Apache%202-green?style=flat-square)](./LICENSE) [![Changelog](https://img.shields.io/badge/-Changelog%20-blueviolet?style=flat-square)](./CHANGELOG.md)

[Cogment](https://cogment.ai) is an innovative open source AI platform designed to leverage the advent of AI to benefit humankind through human-AI collaboration developed by [AI Redefined](https://ai-r.com). Cogment enables AI researchers and engineers to build, train and operate AI agents in simulated or real environments shared with humans. For the full user documentation visit <https://docs.cogment.ai>

🚧 This repository is under construction, it propose a library of environments and agent implementations to get started with Human In the Loop Learning (HILL) and Reinforcement Learning (RL) with Cogment in minutes. Cogment Verse is designed both for practionners discovering the field as well as for experienced researchers or engineers as an framework to develop and benchmark new approaches.

Cogment verse includes environments from:

- [OpenAI Gym](https://gym.openai.com),
- [Petting Zoo](https://www.pettingzoo.ml).

## Getting started

> The full documentation is available [here](./docs/index.md)

### Setup

1. Install [cogment](https://docs.cogment.ai/introduction/installation/) (⚠️ version > 1.2.0 is required)
2. Clone this repository

### Build and run

First run code generation and build the docker images

```console
cogment run sync && cogment run build
```

Start the services

```console
cogment run start
```

Once the services are running, you can run training with the following command

```console
RUN_PARAMS=cartpole_dqn cogment run start_run
```

The available `RUN_PARAMS` are defined in `run_params.yaml`. You can add new parameters as you wish as long as the environments and agents are supported.

An upcoming will make this setting unecessary.

The list ongoing runs you can run

```console
cogment run list_runs
```

An to terminate a given run you can run

```console
RUN_ID=angry_gould cogment run terminate_run
```

Ongoing run identifiers to define `RUN_ID` can be retrieved by listing the ongoing runs with `cogment run list_runs`

## HILL Demo

This is an interactive demo using the Lunar Lander environment. No config changes are required
if you have not modified anything since checking out this commit.

First start the services:

```console
cogment run sync && cogment run build && cogment run start
```

Then start the training client:

```console
xhost local:root # may be necessary for X permissions with docker
RUN_PARAMS=benchmark_lander_hill cogment run start_run
```

Training consists of a sequence of trials (no concurrency) generated by a Rainbow DQN agent.
The trials are displayed in real time. At any time during a trial, you can take control of the
lander with the following controls:

- A: fire right engine, rotate counterclockwise
- D: fire left engine, rotate clockwise
- S: fire bottom engine, slow descent
- ESC: kill all engines, explicit NOP

Initially the agent is untrained and performs very poorly. A little bit of human guidance will
help the agent become much better within a handful of episodes. Once the agent is performing well
you can have some fun by taking control and putting it into difficult situations to see if it
can learn to recover.

For this demo, GPU should not be necessary or even beneficial since the simulation is run in real
time for the benefit of the human observer, which creates a strong bottleneck on performance.

The training algorithm is standard DQN with replay buffer. When the teacher intervenes,
we simply add those transitions to the replay buffer as usual. We use all transitions for
training, whether generated by agent or by intervention. In this way the method is a kind of
simplified version of DAGGER.

## Monitoring

Cogment verse comes with [prometheus](https://prometheus.io), in <./prometheus>, and [grafana](https://grafana.com), in <./grafana>, services to facilitate the monitoring of the cluster.

When running with the default `cogment run start`, the grafana dashboard can be accessed at <http://localhost:3000>.

## GPU

Instead of using `cogment run build` and `cogment run start` use `cogment run build_gpu` and `cogment run start_gpu`.

## Profiling python services

Steps

- Add viztracer to python requirements.txt
- Modify docker-compose override
  - Add a mount for the profile results json/html file
  - Change the entrypoint of the service `viztracer --output_file /output/results.html script.py`
- Rebuild and run jobs

## Acknowledgements

The subdirectories </tf_agents/cogment_verse_tf_agents/third_party> and </torch_agents/cogment_verse_torch_agents/third_party> contains code from third party sources

- `hive`: Taken from the Hive library by MILA/CRL
- `td3`: Taken form the [authors' implementation](https://github.com/sfujim/TD3)
